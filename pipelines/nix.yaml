steps:
- task: CmdLine@2
  displayName: 'Bootstrap vcpkg'
  inputs:
    script: |
      cd $(Build.SourcesDirectory)
      git clone https://github.com/microsoft/vcpkg.git
      cd vcpkg
      git checkout 2025.06.13
      ./bootstrap-vcpkg.sh -disableMetrics
    workingDirectory: '$(Build.SourcesDirectory)'
    failOnStderr: false

- task: CMake@1
  displayName: 'Configure MPSS'
  inputs:
    cmakeArgs: -S . -B build -GNinja -DCMAKE_BUILD_TYPE='${{ parameters.configuration }}' -DMPSS_BUILD_TESTS=ON -DMPSS_BUILD_MPSS_OPENSSL_STATIC=ON -DCMAKE_TOOLCHAIN_FILE=$(Build.SourcesDirectory)/vcpkg/scripts/buildsystems/vcpkg.cmake
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Build MPSS'
  inputs:
    cmakeArgs: --build build --config '${{ parameters.configuration }}'
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CmdLine@2
  displayName: 'Run MPSS unit tests'
  inputs:
    script: 'build/bin/mpss_tests'
    workingDirectory: '$(Build.SourcesDirectory)'
