steps:
- task: Powershell@2
  displayName: 'Get highest installed Android API level'
  inputs:
    targetType: 'inline'
    script: |
        $root = $Env:ANDROID_HOME
        if (-not $root) { throw "ANDROID_HOME not set." }

        $api = (Get-ChildItem "$root\platforms" -Directory |
                Where-Object Name -match '^android-(\d+)$' |
                Sort-Object { [int]($_.Name -replace 'android-','') } -Descending |
                Select-Object -First 1).Name
                
        $api = ($api -replace 'android-')
        
        echo "Will use API level: $api"
        $env:MPSS_ANDROID_API_LEVEL = $api

        echo "Where is Ninja?"
        $ninjaPath = (Get-Command ninja).Source
        if (-not $ninjaPath) {
            throw "Ninja build tool not found. Please install Ninja."
        } else {
            echo "Ninja found at: $ninjaPath"
        }

        dir env:
        $env:ANDROID_HOME = "$(ANDROID_HOME)"
        $env:ANDROID_SDK_ROOT = "$(ANDROID_SDK_ROOT)"
        $env:ANDROID_NDK_HOME = "$(ANDROID_NDK_HOME)"
        $env:ANDROID_NDK_ROOT = "$(ANDROID_NDK_ROOT)"
        Write-Host "Environment variables set for Android SDK and NDK."

- task: CmdLine@2
  displayName: 'Bootstrap vcpkg'
  inputs:
    script: |
      cd $(Build.SourcesDirectory)
      git clone https://github.com/microsoft/vcpkg.git
      cd vcpkg
      git checkout 2025.06.13
      bootstrap-vcpkg.bat -disableMetrics
    workingDirectory: '$(Build.SourcesDirectory)'
    failOnStderr: false

- task: CMake@1
  displayName: 'Configure MPSS for x64'
  inputs:
    cmakeArgs: >
        -S .
        -B build-x64
        -GNinja
        -DCMAKE_BUILD_TYPE='${{ parameters.configuration }}'
        -DCMAKE_SYSTEM_NAME=Android
        -DCMAKE_SYSTEM_VERSION=%MPSS_ANDROID_API_LEVEL%
        -DCMAKE_ANDROID_ARCH_ABI=x86_64
        -DCMAKE_TOOLCHAIN_FILE=$(Build.SourcesDirectory)/vcpkg/scripts/buildsystems/vcpkg.cmake
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Configure MPSS for Arm64'
  inputs:
    cmakeArgs: >
        -S .
        -B build-arm64
        -DCMAKE_BUILD_TYPE='${{ parameters.configuration }}'
        -DCMAKE_SYSTEM_NAME=Android
        -DCMAKE_SYSTEM_VERSION=%MPSS_ANDROID_API_LEVEL%
        -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a
        -DCMAKE_TOOLCHAIN_FILE=$(Build.SourcesDirectory)/vcpkg/scripts/buildsystems/vcpkg.cmake
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Build MPSS for x64'
  inputs:
    cmakeArgs: --build build-x64 --config '${{ parameters.configuration }}'
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Build MPSS for Arm64'
  inputs:
    cmakeArgs: --build build-arm64 --config '${{ parameters.configuration }}'
    workingDirectory: '$(Build.SourcesDirectory)'
