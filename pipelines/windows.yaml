steps:
- ${{ if eq(parameters.configuration, 'Release') }}:
  - task: CredScan@3
    displayName: 'Credential Scan'

  - task: CodeQL3000Init@0
  - task: CodeQL3000Finalize@0

  - task: ComponentGovernanceComponentDetection@0
    inputs:
      scanType: 'Register'
      verbosity: 'Verbose'
      alertWarningLevel: 'High'

- task: CmdLine@2
  displayName: 'Bootstrap vcpkg'
  inputs:
    script: |
      cd $(Build.SourcesDirectory)
      git clone https://github.com/microsoft/vcpkg.git
      cd vcpkg
      git checkout 2025.07.25
      bootstrap-vcpkg.bat -disableMetrics
    workingDirectory: '$(Build.SourcesDirectory)'
    failOnStderr: false

- task: CMake@1
  displayName: 'Configure MPSS'
  inputs:
    cmakeArgs: >
        -S .
        -B build
        -G "Visual Studio 17 2022"
        -DCMAKE_BUILD_TYPE='${{ parameters.configuration }}'
        -DMPSS_BUILD_TESTS=ON
        -DMPSS_BUILD_MPSS_OPENSSL_STATIC=ON
        -DCMAKE_TOOLCHAIN_FILE=$(Build.SourcesDirectory)\vcpkg\scripts\buildsystems\vcpkg.cmake
        -DVCPKG_TARGET_TRIPLET=x64-windows-static-md
    workingDirectory: '$(Build.SourcesDirectory)'

- task: CMake@1
  displayName: 'Build MPSS'
  inputs:
    cmakeArgs: >
      --build build
      --config ${{ parameters.configuration }}
    workingDirectory: '$(Build.SourcesDirectory)'

# Unit tests will fail because TPM cannot be accessed in the Azure Pipelines hosted agents.
# - script: '${{ parameters.configuration }}\mpss_tests.exe'
#   workingDirectory: '$(Build.SourcesDirectory)\build\bin'
#   displayName: 'Run unit tests'

- task: PublishSecurityAnalysisLogs@3
  inputs:
    ArtifactName: 'CodeAnalysisLogs'
    ArtifactType: 'Container'
    PublishProcessedResults: true
    AllTools: true
    ToolLogsNotFoundAction: 'Standard'
